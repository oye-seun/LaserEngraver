<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Laser Engraver</title>
    <style type="text/css">
.canvasDiv {
  display: inline-block;
  z-index: auto;
  border-width: 0px;
  border-style: none;
  text-align: center;
  height: 500px;
  width: 500px;
  margin-left: 20px;
  margin-right: 20px;
  position: relative;
}

#div2 {
  background-attachment: scroll;
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 500px 500px;
  background-clip: border-box;
  background-origin: padding-box;
  font-size: 0px;
  width: 500px;
  height: 500px;
  min-width: 100px;
  max-width: 500px;
  min-height: 500px;
  max-height: 500px;
  padding: 0px;
  margin: 0px;
  display: inline-block;
  z-index: auto;
  text-align: center;
  visibility: visible;
  position: absolute;
  right: 0%;
}

#heading {
  text-transform: uppercase;
  font-size: x-large;
  font-weight: bold;
  text-align: center;
  letter-spacing: 0.5mm;
  font-family: "Arial Rounded MT";
  border-width: 1px;
  border-style: solid;
  border-radius: 10px;
  width: auto;
  min-width: 100px;
  max-width: 500px;
  padding-top: 5px;
  padding-bottom: 5px;
  margin-left: 20px;
  margin-right: 20px;
}

#button {
  width: 50px;
  height: 50px;
  display: block;
  visibility: visible;
  background-image: url("add.png");
  background-attachment: scroll;
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 40px 40px;
  background-color: #e5e5e5;
  float: right;
  border-radius: 10px;
  box-shadow: 7px 7px 10px 0px #a8a9a8;
  z-index: 1;
  position: relative;
}

#button:hover {
  background-color: #d4d4d4;
transition: all 0.4s ease 0s;
}

#button:active {
  background-color: #a4a4a4;
}

#body {
  background-color: #f5fcfd;
}

.listItemFlex {
  display: inline-flex;
  justify-content: space-between;
  flex-grow: 0;
  flex-basis: 0%;
  order: 0;
  align-items: stretch;
  align-self: stretch;
  flex-direction: row;
  width: 95%;
}

.listItem {
  width: 94%;
  font-family: "Arial Rounded MT";
  text-align: left;
  font-size: large;
  background-color: #e5e5e5;
  list-style-type: none;
  border-radius: 10px;
  padding-left: 10px;
  padding-bottom: 10px;
}

.s1ider {
  width: 70%;
}

.listItemHeading {
  top: 10px;
  position: relative;
}

.list {
  min-height: 180px;
  max-height: 1100px;
  overflow-y: scroll;
  width: 550px;
  text-align: center;
  left: 0%;
  margin-left: -10px;
}

#menu_photo, #menu_text, #menu_setting {
  background-attachment: scroll;
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 50px 50px;
  width: 50px;
  height: 50px;
  background-color: #e5e5e5;
  border-radius: 10px;
  padding: 30px;
  border-style: none;
}

#menu_photo:hover, #menu_text:hover, #menu_setting:hover {
  background-color: #d4d4d4;
transition: all 0.4s ease 0s;
}

#menu_photo:active, #menu_text:active, #menu_setting:active {
  background-color: #a4a4a4;
}

#menu_photo {
  background-image: url("photo.png");
}

#menu_text {
  background-image: url("description.png");
}

#menu_setting {
  background-image: url("menu.png");
}

#menu_button_flex {
  display: flex;
  justify-content: space-between;
}

#menu {
  width: 70%;
  padding-top: 20px;
  margin-left: 20px;
  margin-right: 20px;
  flex-direction: column;
  height: 100px;
  justify-content: space-around;
  display: flex;
}

#menu_indicator {
  height: 10px;
  background-color: #d4d4d4;
  width: 60px;
  border-radius: 10px;
  float: left;
}

#upload {
  display: none;
}

#canvas {
  width: 100%;
  background-color: #e5fff3;
  position: absolute;
  right: 0px;
  top: 0px;
  height: 100%;
}

.dimensionsText {
  font-style: normal;
  color: #666666;
  font-family: "Calibri";
  font-weight: normal;
  display: flex;
  align-self: center;
  justify-content: space-between;
  flex-grow: 0;
  flex-shrink: 0;
  width: 160px;
}

.number {
  border-radius: 5px;
  width: 100px;
}

.checkBox {
  display: flex;
  width: 50px;
  font-weight: normal;
  font-family: "Calibri";
  color: #666666;
  margin-left: 5px;
}

.directionButtons{
  width: 80px;
  background-color: #e5e5e5;
  border-radius: 10px;
  box-shadow: 7px 7px 10px 0px #a8a9a8;
  margin: 10px;
  padding: 0;
  border: none;
}

.directionButtons:hover {
  background-color: #d4d4d4;
  transition: all 0.4s ease 0s;
}

.directionButtons:active {
  background-color: #a4a4a4;
}

.functionButtons{
  background-color: #f2f2f2;
  border-radius: 10px;
  box-shadow: 7px 7px 10px 0px #a8a9a8;
  width: 130px;
  height: 28px;
  padding: 0;
  border: none;
}

/* .functionButtons:hover {
  background-color: #d4d4d4;
  transition: all 0.4s ease 0s;
} */

.functionButtons:active {
  background-color: #a4a4a4;
}

#functionButtonsDiv{
  padding-top: 100px;
}

#arrow2{
  transform: rotate(-45deg);
}
#arrow3{
  transform: rotate(45deg);
}
#arrow4{
  transform: rotate(-90deg);
}
#arrow6{
  transform: rotate(90deg);
}
#arrow7{
  transform: rotate(-135deg);
}
#arrow8{
  transform: rotate(180deg);
}
#arrow9{
  transform: rotate(135deg);
}

.list2 {
  min-height: 180px;
  overflow-y: scroll;
  width: 100%;
  margin-left: -40px;
}

.listItemEdit {
  width: 94%;
  font-family: "Arial Rounded MT";
  text-align: left;
  font-size: large;
  background-color: #e5fff3;
  list-style-type: none;
  border-radius: 10px;
  padding-left: 10px;
  padding-bottom: 10px;
}

.directionButtonsHolder {
  width: 94%;
  background-color: #e5e5e5;
  border-radius: 10px;
  padding-left: 10px;
  padding-bottom: 10px;
  list-style-type: none;
  margin-top: 25px;
}
.directionButtonsRow {
  width: 100%;
  display: inline-flex;
  justify-content: space-evenly;
}

.renameField {
  width: 50%;
  border-radius: 5px;
}

#centreBoard{
  min-height: 300px;
  max-height: 1100px;
  width: 550px;
  text-align: center;
}

.center1{
  display: block;
}

.center2{
  display: none;
}

#status{
  min-height: 100px;
  min-width: 200px;
  width: 90%;
  overflow-y: scroll;
  text-align: left;
  font-size: large;
  padding-left: 2.5%;
  padding-right: 2.5%;
  border-radius: 10px;
  margin-left: 2.5%;
  margin-right: 2.5%;
  background-color: #f9f9f9;
  align-self: center;
}

#statusContainer{
  min-height: 100px;
  min-width: 200px;
  width: 94%;
  text-align: left;
  font-size: large;
  padding-bottom: 10px;
  border-radius: 10px;
  background-color: #e5e5e5;
  padding-left: 10px;
}

.result{
  width: 50px;
}

.overlay {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  z-index: 10;
  background-color: rgba(0, 0, 0, 0.6);
}

.modal {
  width: 300px;
  height: 200px;
  font-family: "Arial Rounded MT";
  line-height: 200px;
  position: fixed;
  top: 40%;
  left: 50%;
  margin-top: -100px;
  margin-left: -150px;
  background-color: #e5fff3;
  border-radius: 40px;
  text-align: center;
  z-index: 11;
}
#sendElement{
  display: none;
}

</style>
<meta name="viewport" content="width=500, user-scalable=0" />
</head>
<body id="body">
    <center><h2 id="heading"> Laser Engraver </h2></center>
    <center class="center1">
      <div class="canvasDiv"> <canvas id="canvas" width="1000" height="1000"></canvas> <input

          id="upload" type="file"> <label for="upload" id="button"></label> </div>
      <div>
        <ul role="list" class="list">
          <li class="listItem">
            <h4 class="listItemHeading">Dimensions</h4>
            <div class="listItemFlex">
              <div class="checkBox">Auto<input checked="checked" id="autoscale"

                  type="checkbox"></div>
              <div class="dimensionsText">
                <div>L</div>
                <input class="number" id="length" type="number"><span>mm</span></div>
              <div class="dimensionsText">
                <div>W</div>
                <input class="number" id="width" type="number"><span>mm</span></div>
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">Lines Per mm</h4>
            <div class="listItemFlex"><img src="measure.png"

                style="width: 28px; height: 28px;"> 
                <input class="s1ider" min="1" max="20" value="4" type="range" id="lpmm">
              <div class="result" id="lpmmResult">4</div>
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">Brightness</h4>
            <div class="listItemFlex"><img src="light.png"

                style="width: 28px; height: 28px;"> 
                <input class="s1ider" min="0" max="150" value="0" type="range" id="brightness">
              <div class="result" id="brightnessResult">0</div>
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">FeedRate</h4>
            <div class="listItemFlex"><img src="feedrate.png"

                style="width: 28px; height: 28px;">
              <input class="s1ider" min="1" max="3000" value="500" type="range" id="feedrate">
              <div class="result" id="feedrateResult">500</div>
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">Power</h4>
            <div class="listItemFlex"><img src="cut.png" style="width: 28px; height: 28px;" alt="cut" title="cut"> 
              <input class="s1ider" min="15" max="100"value="0" type="range" id="power">
              <div class="result" id="powerResult">15</div>
            </div>
          </li>
        </ul>
      </div>
    </center>

    <div id="sendElement">
      <div class="overlay"></div>
      <div class="modal">
        SENDING
      </div>
    </div>

    <center class="center2">
      <!-- <label for="jobProgress">Completion</label>
      <progress id="jobProgress" value="50" max="100"></progress> -->
      <div id="centreBoard">

        <div id="statusContainer">
          <h4 class="listItemHeading">Serial Port</h4>
          <p id="status"> this is a paragragh of GRBL replies</p>
          <div class="listItemFlex">
            <img src="action.png" style="width: 28px; height: 28px;"> 
            <input class="renameField" type="text" id="fname">
            <button type="button" class="functionButtons">Send</button> 
          </div>
        </div>
  
        <div class="listItemEdit">
          <h4 class="listItemHeading" id="currentJob">Job: </h4>
          <div class="listItemFlex">
            <img src="description.png" style="width: 28px; height: 28px;"> 
            <input class="renameField" type="text" id="jobRename">
            <button type="button" class="functionButtons">Rename</button> 
          </div>
        </div>
        <ul role="list" class="list2">
          <li class="listItem">
            <h4 class="listItemHeading">Status</h4>
            <div class="listItemFlex">
              <button type="button" class="functionButtons" id="unlock">Unlock</button> 
              <button type="button" class="functionButtons" id="flush">Flush</button> 
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">Positioning</h4>
            <div class="listItemFlex">
              <button type="button" class="functionButtons">Frame</button> 
              <button type="button" class="functionButtons">Focus</button>
              <button type="button" class="functionButtons" id="blink">Blink</button> 
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">Homing</h4>
            <div class="listItemFlex">
              <button type="button" class="functionButtons">Find Home</button> 
              <button type="button" class="functionButtons" id="corners">Job Corners</button>
              <button type="button" class="functionButtons">Set Home</button>
            </div>
          </li>
          <li class="directionButtonsHolder">
            <div class="directionButtonsRow"> 
              <button type="button" class="directionButtons" id="btn1"><img src="arrow.png" id="arrow2"></button> 
              <button type="button" class="directionButtons" id="btn2"><img src="arrow.png" id="arrow1"></button> 
              <button type="button" class="directionButtons" id="btn3"><img src="arrow.png" id="arrow3"></button> 
            </div>
            <div class="directionButtonsRow"> 
              <button type="button" class="directionButtons" id="btn4"><img src="arrow.png" id="arrow4"></button> 
              <button type="button" class="directionButtons" id="btn5"><img src="home.png" ></button> 
              <button type="button" class="directionButtons" id="btn6"><img src="arrow.png" id="arrow6"></button> 
            </div>
            <div class="directionButtonsRow"> 
              <button type="button" class="directionButtons" id="btn7"><img src="arrow.png" id="arrow7"></button> 
              <button type="button" class="directionButtons" id="btn8"><img src="arrow.png" id="arrow8"></button> 
              <button type="button" class="directionButtons" id="btn9"><img src="arrow.png" id="arrow9"></button> 
            </div>
          </li>
          <li class="listItem">
            <h4 class="listItemHeading">Operation</h4>
            <div class="listItemFlex">
              <button type="button" class="functionButtons" id="startButton">Start</button> 
              <button type="button" class="functionButtons">Pause</button>
              <button type="button" class="functionButtons">End</button>
            </div>
          </li>
        </ul>
      </div>

    </center>


    <center>
      <div id="menu">
        <div>
          <div id="menu_indicator"> </div>
        </div>
        <div id="menu_button_flex"> 
          <button id="menu_photo"> </button> 
          <!-- <button id="menu_text"> </button>  -->
          <button id="menu_setting"> </button> 
        </div>
      </div>
    </center>
    <script>
      const input = document.querySelector("#upload");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const homeOffset = 30;
      let xoff = 0.0, yoff = 0.0;
      let dragging = -1;
      let scale = 250;
      
      let canvas2 = document.createElement('canvas');
      let ctx2 = canvas2.getContext('2d');
      canvas2.width = 0;
      canvas2.height = 0;
      let imgData = new ImageData(10, 10);
      let rasterImg = new ImageData(1, 1);
      // let imgArr = new Uint8ClampedArray(1);
      let arrLen = 0;
      let pxPerLine = 0;

      let imgX = 100, imgY = 100;   // image start psoition
      let imgWidth = 0, imgHeight = 0;
      let aspect = 0;

      const length = document.getElementById("length");
      const width = document.getElementById("width");
      const auto = document.getElementById("autoscale");
      length.value = 100;

      const ongoingTouches = [];
      let identifier = 0;
      
      render(xoff, yoff);
      
      //..........Handle Add Images..................................................
      input.addEventListener("change", () => {
        let reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.addEventListener("load", () => {
          let img = new Image;
          img.src = reader.result;
          img.onload = function(){
            //convert to black and white
            canvas2.width = img.width;
            canvas2.height = img.height;
            ctx2.drawImage(img, 0, 0);
            imgData = ctx2.getImageData(0, 0, canvas2.width, canvas2.height);
            for (let i = 0; i < imgData.data.length; i += 4) {
              let colour = (imgData.data[i] + imgData.data[i + 1] + imgData.data[i + 2])/3;
              imgData.data[i] = colour;
              imgData.data[i + 1] = colour;
              imgData.data[i + 2] = colour;
            }

            // put the image in
            rasterImage();

            // ctx2.putImageData(imgData, 0, 0);
            aspect = img.width/img.height;
            handleLengthChange(true);
            // render(xoff, yoff);
          }
        });
      });
      //.............................................................................


      function rasterImage(){

        const arr = new Uint8ClampedArray(imgData.data.length);
        for (let i = 0; i < arr.length; i += 4) {
          arr[i + 0] = imgData.data[i + 0];
          arr[i + 1] = imgData.data[i + 1];
          arr[i + 2] = imgData.data[i + 2];
          arr[i + 3] = 0;
          // if (imgData.data[i + 3] === 0) arr[i + 3] = 1;
          // else arr[i + 3] = 0;
        }

        arrLen = Math.round(lPmm.value * length.value);
        pxPerLine = canvas2.height/arrLen;
        // imgArr = new Uint8ClampedArray(canvas2.width * arrLen * 2);
        for (let i = 0; i < arrLen; i++) {
          let yelement = Math.round( i * pxPerLine) * 4 * canvas2.width;
          for(let j = 0; j < canvas2.width; j++){
            // imgArr[(i*canvas2.width*2) + (j*2)] =  imgData.data[yelement + (j*4)];
            // imgArr[(i*canvas2.width*2) + (j*2) + 1] =  imgData.data[yelement + (j*4) + 3];

            let pos = (yelement +  (j*4) + 3);
            if(pos < imgData.data.length){
              // if(arr[pos] === 1) arr[pos] = 0;
              // else arr[pos] = 255;
              arr[pos] = imgData.data[pos];
            }
          }
        }
        rasterImg = new ImageData(arr, imgData.width, imgData.height, imgData.settings);
        ctx2.putImageData(rasterImg, 0, 0);
      }

      //.........Handle Scaling................................................
      length.addEventListener("change", ()=>{handleLengthChange(auto.checked)});
      function handleLengthChange(auto){
        if(auto){
          width.value = imgWidth = length.value * aspect;
          imgHeight = length.value;
        }
        else imgHeight = length.value;
        rasterImage();
        render(xoff, yoff);
      }

      width.addEventListener("change", ()=>{handleWidthChange(auto.checked)});
      function handleWidthChange(auto){
        if(auto){
          length.value = imgHeight = width.value / aspect;
          imgWidth = width.value;
        }
        else imgWidth = width.value;
        rasterImage();
        render(xoff, yoff);
      }
      //.............................................................................

      //........Srolling and Panning................................................
      function inputScroll(deltaY){
        scale += deltaY * -0.1;
        if(scale < 250) scale = 250;
        if(scale > 1000) scale = 1000;
        render(xoff, yoff);
      }
      
      function inputDown(clientX, clientY){
        const rect = canvas.getBoundingClientRect();
        let xdown = clientX - rect.left;
        let ydown = canvas.clientWidth - (clientY - rect.top);
        if(checkPosInImage(xdown, ydown)) dragging = 0; // started drag over image
        else dragging = 1;
      }

      function inputUp(){
        dragging = -1;
      }

      function inputMove(movementX, movementY){
        if(dragging === 0){
          imgX += movementX * 1;
          imgY += movementY * -1;

          if(imgX < 0) imgX = 0;
          if(imgY < 0) imgY = 0;

          render(xoff, yoff);
        }
        else if(dragging === 1) {
          xoff += movementX * -1;
          yoff += movementY * 1;

          // prevent x and y from going below 0
          if(xoff < 0) xoff = 0;
          if(yoff < 0) yoff = 0;
          render(xoff, yoff);
        }
      }

      canvas.onwheel = function (evt){
        evt.preventDefault()
        inputScroll(evt.deltaY);
      }


      canvas.onmousedown = function(e){
        e.preventDefault();
        inputDown(e.clientX, e.clientY);
      }
      canvas.ontouchstart = function(e){
        e.preventDefault();
        const touches = e.changedTouches;
        identifier = touches[0].identifier;
        inputDown(touches[0].clientX, touches[0].clientY);
        for(let i = 0; i < touches.length; i ++){
          ongoingTouches.push(copyTouch(touches[i]));
        }
      }

      canvas.onmouseup = inputUp;
      canvas.onmouseleave = inputUp;
      canvas.ontouchend = function(e){
        e.preventDefault();
        const touches = e.changedTouches;
        for(let i = 0; i < touches.length; i ++){
          let idx = ongoingTouchIndexById(touches[i].identifier);
          if(idx >= 0) ongoingTouches.splice(idx, 1);
          if (idx === identifier) inputUp();
        }
      }

      canvas.onmousemove = function (e){
        e.preventDefault();
        inputMove(e.movementX * 0.8 * (250/scale), e.movementY * 0.8 *(250/scale));
      }

      canvas.ontouchmove = function(e){
        e.preventDefault();
        const touches = e.changedTouches;

        if(touches.length === 2){   // handle zooming
          let idx0 = ongoingTouchIndexById(touches[0].identifier);
          let idx1 = ongoingTouchIndexById(touches[1].identifier);

          let dist0 = distance(ongoingTouches[idx0].clientX, ongoingTouches[idx0].clientY, ongoingTouches[idx1].clientX, ongoingTouches[idx1].clientY);
          let dist1 = distance(touches[0].clientX, touches[0].clientY, touches[1].clientX, touches[1].clientY);
          
          inputScroll((dist0 - dist1) * 1.5);
        }

        if(touches.length > 1) return;

        for(let i = 0; i < touches.length; i++){
          let idx = ongoingTouchIndexById(touches[i].identifier);
          if(touches[i].identifier === identifier){  // first touch, handle drag movement
            inputMove((touches[i].clientX - ongoingTouches[idx].clientX)*(250/scale), (touches[i].clientY - ongoingTouches[idx].clientY)*(250/scale));
          }
          if(idx >= 0) ongoingTouches.splice(idx, 1, copyTouch(touches[i])); 
        }
        // console.log("touches: " + e.touches[0]);
      }

      function copyTouch({ identifier, clientX, clientY }) {
        return { identifier, clientX, clientY };
      }
      function ongoingTouchIndexById(idToFind) {
        for (let i = 0; i < ongoingTouches.length; i++) {
          const id = ongoingTouches[i].identifier;

          if (id === idToFind) return i;
        }
        return -1; // not found
      }
      function distance(x1, y1, x2, y2){
        return Math.sqrt(((x2 - x1) * (x2 - x1)) + ((y2 - y1) * (y2 - y1)));
      }

      //........Srolling and Panning END....................................................................


      //.........Lines Per MM...............................................................................
      const lPmm = document.getElementById("lpmm");
      lPmm.addEventListener("input", ()=>{
        document.getElementById("lpmmResult").innerHTML = lPmm.value;
      })

      lPmm.addEventListener("change", ()=>{
        rasterImage();
        render(xoff, yoff);
      })
      //....................................................................................................


      //..........Brightness.................................................................................
      const brightness = document.getElementById("brightness");
      brightness.addEventListener("change", ()=>{
        const arr = new Uint8ClampedArray(rasterImg.data.length);
        for (let i = 0; i < arr.length; i += 4) {
          arr[i + 0] = rasterImg.data[i + 0] + (brightness.value/2);
          arr[i + 1] = rasterImg.data[i + 1] + (brightness.value/2);
          arr[i + 2] = rasterImg.data[i + 2] + (brightness.value/2);
          arr[i + 3] = rasterImg.data[i + 3];
        }

        let newImgData = new ImageData(arr, rasterImg.width, rasterImg.height, rasterImg.settings);
        ctx2.putImageData(newImgData, 0, 0);
        render(xoff, yoff);
      })

      brightness.addEventListener("input", ()=>{
        document.getElementById("brightnessResult").innerHTML = brightness.value;
      })
      //..........Brightness END.............................................................................
      

      //...........Feed Rate................................................................................
      const feedrate = document.getElementById("feedrate");
      feedrate.addEventListener("input", ()=>{
        document.getElementById("feedrateResult").innerHTML = feedrate.value;
      })
      //....................................................................................................

      //...........Power   ................................................................................
      const power = document.getElementById("power");
      power.addEventListener("input", ()=>{
        document.getElementById("powerResult").innerHTML = power.value;
      })
      //....................................................................................................

      // render all items on the canvas
      function render(x, y){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();

        renderImage(x, y);
        renderLines(x, y);
      }

      // render image and boundary
      function renderImage(x, y){
        if(canvas2.height > 0){ 
          let i = (imgX * scale/100) - x + homeOffset;
          let j = (imgY * scale/100) - y + (imgHeight * scale/100) + homeOffset;
          ctx.drawImage(canvas2, i, shiftY(j), imgWidth * scale/100, imgHeight * scale/100);
          // ctx.putImageData(imgData, i, shiftY(j), 0, 0, imgWidth * scale/100, imgHeight * scale/100);
          ctx.setLineDash([6, 3]);
          ctx.strokeStyle = '#ff5959'
          ctx.strokeRect(i, shiftY(j), imgWidth * scale/100, imgHeight * scale/100);
        }

        if(rasterImg.data.length > 10){
          let i = (imgX * scale/100) - x + homeOffset;
          let j = (imgY * scale/100) - y + (imgHeight * scale/100) + homeOffset;
          ctx.drawImage(canvas2, i, shiftY(j), imgWidth * scale/100, imgHeight * scale/100);
          // ctx.putImageData(imgData, i, shiftY(j), 0, 0, imgWidth * scale/100, imgHeight * scale/100);
          ctx.setLineDash([6, 3]);
          ctx.strokeStyle = '#ff5959'
          ctx.strokeRect(i, shiftY(j), imgWidth * scale/100, imgHeight * scale/100);
        }
      }

      // check if the position is on the image
      function checkPosInImage(x, y){
        if(canvas2.width <= 0 || canvas2.height <= 0) return false;

        //transform x, y to canvas x, y
        x *= canvas.width/canvas.clientWidth;
        y *= canvas.height/canvas.clientHeight;

        let i = (imgX * scale/100) - xoff + homeOffset;
        let j = (imgY * scale/100) - yoff + homeOffset;

        if(x < i || x > i + (imgWidth * scale/100)) return false;
        else if ((y < j || y > j + (imgHeight * scale/100))) return false;
        else return true;
      }

      // render cartesian coordinates, should be rendered last
      function renderLines(x, y){
        ctx.font = homeOffset + "px Arial";
        
        itr = canvas.width/scale
        const subitr = 10;
        
        let startX = Math.ceil(x/scale);
        for(let i = startX; i < itr + startX + 1; i++){
          ctx.beginPath();
          ctx.setLineDash([10, 6]);
          ctx.strokeStyle = '#000000';
          ctx.moveTo((i*scale) - x + homeOffset, shiftY(homeOffset));
          ctx.lineTo((i*scale) - x + homeOffset, shiftY(canvas.height));
          ctx.stroke();
          if(i != 0) ctx.fillText(i, (i * scale) - 8 - x + homeOffset, shiftY(0));

          // sub iterations
          let unitDist = scale/subitr;
          for(let j = 1; j < subitr; j++){
            let xpos = ((i - 1)*scale) - x + homeOffset + (unitDist * j);
            if(xpos > homeOffset){
              ctx.beginPath();
              ctx.setLineDash([6, 6]);
              ctx.strokeStyle = '#888888';
              ctx.moveTo(xpos, shiftY(homeOffset));
              ctx.lineTo(xpos, shiftY(canvas.height));
              ctx.stroke();
            }
          }
        }
        
        let startY = Math.ceil(y/scale);
        for(let i = startY; i < itr + startY + 1; i++){
          ctx.beginPath();
          ctx.setLineDash([10, 6]);
          ctx.strokeStyle = '#000000';
          ctx.moveTo(homeOffset, shiftY((i*scale) - y + homeOffset));
          ctx.lineTo(canvas.width, shiftY((i*scale) - y + homeOffset));
          ctx.stroke();
          if(i != 0) ctx.fillText(i, 0, shiftY((i * scale) - 8 - y + homeOffset));

          // sub iterations
          let unitDist = scale/subitr;
          for(let j = 1; j < subitr; j++){
            let ypos = ((i - 1)*scale) - y + homeOffset + (unitDist * j);
            if(ypos > homeOffset){
              ctx.beginPath();
              ctx.setLineDash([6, 6]);
              ctx.strokeStyle = '#888888';
              ctx.moveTo(homeOffset, shiftY(ypos));
              ctx.lineTo(canvas.width, shiftY(ypos));
              ctx.stroke();
            }
          }
        }
      }

      // shift Y coordinate to start from bottom
      function shiftY(y){
        return canvas.height - y;
      }

      //........

      //........Handle Sizing..........................................................
      let canvasDiv = document.querySelector('.canvasDiv');
      let list = document.querySelector('.list');
      let menu = document.querySelector('#menu');
      let heading = document.querySelector('#heading');
      let centreBoard = document.querySelector('#centreBoard');
      let list2 = document.querySelector('.list2');

      if(window.innerWidth < 1000) {
        canvasDiv.style.width = canvasDiv.style.height = Math.floor(0.8 * window.innerWidth).toString() + "px";
        list.style.width = Math.floor(0.9 * window.innerWidth).toString() + "px";
        menu.style.width = Math.floor(0.7 * window.innerWidth).toString() + "px";
        centreBoard.style.width = Math.floor(0.9 * window.innerWidth).toString() + "px";
        list.style.height = (window.innerHeight - canvasDiv.clientHeight - menu.clientHeight - heading.clientHeight - 100).toString() + "px";
        list2.style.height = (window.innerHeight - menu.clientHeight - heading.clientHeight - 417).toString() + "px";

        if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
          menu.style.marginLeft = menu.style.marginRight = Math.floor((window.innerWidth * 0.3)/2).toString() + "px";
          canvasDiv.style.marginLeft = canvasDiv.style.marginRight = Math.floor((window.innerWidth * 0.2)/2).toString() + "px";
          centreBoard.style.marginLeft = centreBoard.style.marginRight = Math.floor((window.innerWidth * 0.1)/2).toString() + "px";
          heading.style.width = heading.clientWidth + "px";
          heading.style.marginLeft = heading.style.marginRight = Math.floor((window.innerWidth - heading.clientWidth)/2).toString() + "px";
        }
      }
      else {
          list.style.width = "550px";
          canvasDiv.style.width = canvasDiv.style.height = "500px";
          centreBoard.style.width = "550px";
          list2.style.height = (window.innerHeight - menu.clientHeight - heading.clientHeight - 417).toString() + "px";
          menu.style.width = "400px";
          list.style.height = "180px";
      }
      //...............................................................................
      

      // //........GCODE..................................................................
      // function generateGCode(){
      //   TestImage();
      //   return;
      //   // socket.send('z');
      //   let mmPerLine = 1/lPmm.value;
      //   let mmPerPx = width.value/canvas2.width;
      //   for (let i = 0; i < arrLen; i++) {
      //     // socket.send("G00 X" + imgX  + " Y" + (imgY + (i*mmPerLine)));
      //     console.log("G00 X" + imgX  + " Y" + (imgY + (i*mmPerLine)));
      //     let yStart = i*canvas2.width*2;
      //     for(let j = 0; j < canvas2.width - 1; j++){
      //       let currentPX = (imgArr[yStart + (j*2)] + imgArr[yStart + (j*2) + 1]);
      //       let nextPX = (imgArr[yStart + ((j + 1)*2)] + imgArr[yStart + ((j + 1)*2) + 1]);
      //       console.log("current px: " + currentPX + " nextpx: " + nextPX);
      //       if(currentPX  === nextPX){
      //         continue;
      //       }
      //       else{
      //         // if(imgArr[(i*arrLen) + (j*2)]  === 255) socket.send("G00 X" + (imgX + ((j+1)*mmPerPx)));
      //         if(imgArr[yStart + (j*2) + 1] === 0) console.log("G00 X" + (imgX + ((j+1)*mmPerPx)) + " px value: " + imgArr[yStart + (j*2)]);
      //         // else socket.send("G01 X" + (imgX + ((j+1)*mmPerPx))  + " S" + ((255-imgArr[(i*arrLen) + (j*2)])*0.3));
      //         else console.log("G01 X" + (imgX + ((j+1)*mmPerPx))  + " S" + ((255-imgArr[yStart + (j*2)])*imgArr[yStart + (j*2)+1]*0.3) + " px value: " + imgArr[yStart + (j*2)]);
      //       }
      //     } 

      //     // socket.send("G01 X" + (imgX + ((canvas2.width)*mmPerPx))  + " S" + ((255-imgArr[(i*arrLen) + canvas2.width - 1])*0.3));
      //   }
      //   // socket.send('y');
      // }
      // //...............................................................................


      function generateGCode2(){   //this is deprecated
        socket.send('z');
        let mmPerLine = 1/lPmm.value;
        let mmPerPx = width.value/canvas2.width;
        socket.send("G90\n" +"G0 X0 Y0 F" + feedrate.value + "\n" + "M4 S0");
        for (let i = 0; i < arrLen; i++) {
          socket.send("G00 X" + imgX  + " Y" + (imgY + (i*mmPerLine)));
          // console.log("G00 X" + imgX  + " Y" + (imgY + (i*mmPerLine)));
          let yelement = Math.round( i * pxPerLine) * 4 * canvas2.width;
          for(let j = 0; j < canvas2.width; j++){
            let rpos = (yelement +  (j*4));
            let rpos2 = (yelement +  ((j+1)*4));
            let apos = rpos + 3;
            let apos2 = rpos2  + 3;
            let currentPX = rasterImg.data[rpos];
            let currentPXa = rasterImg.data[apos];

            if(apos >= rasterImg.data.length || apos2 >= rasterImg.data.length){
              continue;
            }

            // arr[pos] = imgData.data[pos];
            if(currentPX + currentPXa  === rasterImg.data[rpos2] + rasterImg.data[apos2]){
              // console.log("currentPX: " + currentPX + " nextpx: " + rasterImg.data[rpos2]);
              // console.log("currentPX: " + rpos + " nextpx: " + rpos2);
              continue;
            }
            else{
              let x = (imgX + ((j+1)*mmPerPx));
              let s = ((255-currentPX)*currentPXa* power.value * 10/65025);
              if(currentPXa === 0) socket.send("G00 X" + x/* + " px value: " + currentPX*/);
              // if(currentPXa === 0) console.log("G00 X" + x/* + " px value: " + currentPX*/);
              else socket.send("G01 X" + x  + " S" +  s/*+ " px value: " + imgArr[yStart + (j*2)]*/);
              // else console.log("G01 X" + x  + " S" +  s/*+ " px value: " + imgArr[yStart + (j*2)]*/);
            }
          }
        }
        socket.send("M5");
        socket.send('y');
      }

      // line to line tracing
      function generateGCode3(){
        const formData = new FormData();
        let mmPerLine = 1/lPmm.value;
        let mmPerPx = width.value/canvas2.width;
        let gString = "G90\n" +"G0 X0 Y0 F" + feedrate.value + "\n" + "M4 S0\n";
        for (let i = 0; i < arrLen; i++) {
          gString = gString.concat("G00 X" + imgX  + " Y" + (imgY + Number(length.value) - (i*mmPerLine)) + "\n");
          let yelement = Math.round( i * pxPerLine) * 4 * canvas2.width;
          for(let j = 0; j < canvas2.width; j++){
            let rpos = (yelement +  (j*4));
            let rpos2 = (yelement +  ((j+1)*4));
            let apos = rpos + 3;
            let apos2 = rpos2  + 3;
            let currentPX = rasterImg.data[rpos];
            let currentPXa = rasterImg.data[apos];
            if(apos >= rasterImg.data.length || apos2 >= rasterImg.data.length){
              continue;
            }
            if(currentPX + currentPXa  === rasterImg.data[rpos2] + rasterImg.data[apos2]){
              continue;
            }
            else{
              let x = (imgX + ((j+1)*mmPerPx));
              let s = ((255-currentPX)*currentPXa* power.value * 10/65025);
              if(currentPXa === 0)
              { 
                gString = gString.concat("G00 X" + x + "\n");
              }
              else
              {
                gString = gString.concat("G01 X" + x  + " S" +  s + "\n");
              }
            }
          }
        }
        gString = gString.concat("M5" + "\n");
        let blob = new Blob([gString], { type: 'plain/text' });
        formData.append('file', blob, 'GCode1.txt');
        const request = new XMLHttpRequest();
        request.upload.addEventListener("progress", function (event) {
          if(event.lengthComputable) {
            document.querySelector('.modal').innerHTML = "SENDING......" + Math.round((event.loaded / event.total) * 100) + "%";
          }
        });
        request.open('POST', '/fupload');
        console.log("upload time: " + Date.now());
        request.send(formData);
      }


      function pixelVal(img, x, y){
        x = (x > img.width)? img.width - 1 : x;
        x = (x < 0)? 0 : x;
        y = (y > img.height)? img.height - 1 : y;
        y = (y < 0)? 0 : y;

        // console.log("X: " + x + " Y: " + y);
        // console.log("img width: " + img.width);
        // let alpha = img.data[(y*img.width*4) + (x*4) + 3];
        // if(alpha)
        return (255 - img.data[(y*img.width*4) + (x*4)]) * (img.data[(y*img.width*4) + (x*4) + 3]/255);
      }

      // vectorize
      function generateGCode4(){
        const formData = new FormData();
        let gString = "G90\n" +"G0 X0 Y0 F" + feedrate.value + "\n" + "M4 S0\n";

        let mmPerPxAxisX = Number(width.value)/rasterImg.width;
        let mmPerPxAxisY = Number(length.value)/rasterImg.height;

        for (let j = 0; j < rasterImg.height; j++) {
          for(let i = 0; i < rasterImg.width; i++){
            let center = 255 - pixelVal(rasterImg, i, j);
            if(center > 150) continue;

            let left = pixelVal(rasterImg, i - 1, j);
            let right = pixelVal(rasterImg, i + 1, j);
            let up = pixelVal(rasterImg, i, j + 1);
            let down = pixelVal(rasterImg, i, j - 1);

            let s = (center * power.value * 10/255);

            let horzTotal = left + center + right;
            let xval =  (((i - 1) * left/horzTotal) + (i * center/horzTotal) + ((i + 1) * right/horzTotal)) * mmPerPxAxisX;

            let vertTotal = up + center + down;
            let yval = (((j - 1) * down/vertTotal) + (j * center/vertTotal) + ((j + 1) * up/vertTotal)) * mmPerPxAxisY;

            gString = gString.concat("G01 X" + xval  + " Y" + yval + " S" +  s + "\n");
          }
        }

        gString = gString.concat("M5" + "\n");

        let blob = new Blob([gString], { type: 'plain/text' });
        formData.append('file', blob, 'GCode1.txt');

        const request = new XMLHttpRequest();
        request.upload.addEventListener("progress", function (event) {
          if(event.lengthComputable) {
            document.querySelector('.modal').innerHTML = "SENDING......" + Math.round((event.loaded / event.total) * 100) + "%";
          }
        });

        request.open('POST', '/fupload');
        console.log("upload time: " + Date.now());
        request.send(formData);
      }

      // function TestImage(){
      //   const arr = new Uint8ClampedArray(arrLen * canvas2.width * 4);

      //   let mmPerLine = 1/lPmm.value;
      //   let mmPerPx = width.value/canvas2.width;
      //   for (let i = 0; i < arrLen; i++) {
      //     for(let j = 0; j < canvas2.width; j++){
      //       let yStart = i*canvas2.width*4;
      //       let aryStart = i*canvas2.width*2;
      //       arr[yStart + (j*4)] = imgArr[aryStart + (j*2)];
      //       arr[yStart + (j*4) + 1] = imgArr[aryStart + (j*2)];
      //       arr[yStart + (j*4) + 2] = imgArr[aryStart + (j*2)];
      //       arr[yStart + (j*4) + 3] = imgArr[aryStart + (j*2) + 1];
      //     }
      //   }
      //   let newImgData = new ImageData(arr, canvas2.width, arrLen, imgData.settings);
      //   ctx2.putImageData(newImgData, 0, 0);
      //   render(xoff, yoff);
      // }

      //.........Handle Switching Tabs.................................................
      const center1 = document.querySelector('.center1');
      const center2 = document.querySelector('.center2');
      const menuIndicator = document.querySelector('#menu_indicator');
      const menuPhoto = document.querySelector('#menu_photo');
      const sendElement = document.querySelector('#sendElement');
      menuPhoto.onclick = function(){
        center1.style.display = "block";
        center2.style.display = "none";
        menuIndicator.style.float = "left";
      }
      let menu_settings = document.querySelector('#menu_setting')
      menu_settings.onclick = function(){
        sendElement.style.display = "block";
        generateGCode3();
        // generateGCode4();
      }
      //...............................................................................

      //..........Attaching control buttons............................................
      let corners = false;
      const jobCorners = document.querySelector('#corners');
      jobCorners.onclick = function (){
        if(!corners) {
          corners = true;
          jobCorners.style.background = "#a4a4a4";
        }
        else{
          corners = false;
          jobCorners.style.background = "#f2f2f2";
        }
      }

      let valX = 0;
      let valY = 0;
      function recalcOffsets(){
        valX = imgX + Number(width.value);
        valY = imgY + Number(length.value);
      }

      const btn1 = document.querySelector('#btn1');
      btn1.onclick = function (){
        if(corners) {
          recalcOffsets();
          socket.send("G00 X" + imgX  + " Y" + valY);
        }
        else socket.send("$J=G91X-1.0Y1.0F" + feedrate.value);
      }

      const btn2 = document.querySelector('#btn2');
      btn2.onclick = function (){socket.send("$J=G91Y1.0F" + feedrate.value);}

      const btn3 = document.querySelector('#btn3');
      btn3.onclick = function (){
        if(corners) {
          recalcOffsets();
          socket.send("G00 X" + valX  + " Y" + valY);
        }
        else socket.send("$J=G91X1.0Y1.0F" + feedrate.value);
      }

      const btn4 = document.querySelector('#btn4');
      btn4.onclick = function (){socket.send("$J=G91X-1.0F" + feedrate.value);}

      const btn5 = document.querySelector('#btn5');
      btn5.onclick = function (){socket.send("$J=G90X0Y0F" + feedrate.value);}

      const btn6 = document.querySelector('#btn6');
      btn6.onclick = function (){socket.send("$J=G91X1.0F" + feedrate.value);}

      const btn7 = document.querySelector('#btn7');
      btn7.onclick = function (){
        if(corners) socket.send("G00 X" + imgX  + " Y" + imgY);
        else socket.send("$J=G91X-1.0Y-1.0F" + feedrate.value);
      }

      const btn8 = document.querySelector('#btn8');
      btn8.onclick = function (){socket.send("$J=G91Y-1.0F" + feedrate.value);}

      const btn9 = document.querySelector('#btn9');
      btn9.onclick = function (){
        if(corners) {
          recalcOffsets();
          socket.send("G00 X" + valX  + " Y" + imgY);
        }
        else socket.send("$J=G91X1.0Y-1.0F" + feedrate.value);
      }

      var date = new Date();

      const unlock = document.querySelector('#unlock');
      unlock.onclick = function (){console.log("unlock sendtime: " + Date.now()); socket.send("$X");}
      
      const flush = document.querySelector('#flush');
      flush.onclick = function (){console.log("flush sendtime: " + Date.now()); socket.send('1'); }
      
      const blink = document.querySelector('#blink');
      blink.onpointerdown = function (){socket.send("M3 G1 F100 S30");}
      blink.onpointerup = function (){socket.send("M5");}

      const startButton = document.querySelector('#startButton');
      startButton.onclick = function (){socket.send('2');}

      const command = document.getElementById("fname");
      command.addEventListener("change", ()=>{
        socket.send(command.value);
      });
      //...............................................................................

      //..........WebSocket Communication..............................................
      const socket = new WebSocket("ws:/" + "/" + location.host + ":81");
      socket.onopen = function(e) {  console.log("[socket] socket.onopen "); };
      socket.onerror = function(e) {  console.log("[socket] socket.onerror "); };
      socket.onmessage = function(e) {  
          // console.log("[socket] " + e.data);
          if(e.data === "received"){
            sendElement.style.display = "none";
            center2.style.display = "block";
            center1.style.display = "none";
            menuIndicator.style.float = "right";

            console.log("upload finished time: " + Date.now());
          }
          else{
            console.log("response receive time: " + Date.now());
            document.getElementById("status").innerHTML = e.data;
          }
      };

      //...............................................................................
    </script>
  </body>
</html>
